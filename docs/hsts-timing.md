# Временные аспекты HSTS и EnvoyFilter

Этот документ объясняет, когда создается EnvoyFilter для отключения HSTS, когда браузер кеширует HSTS заголовок, и как оператор предотвращает кеширование HSTS до первого обращения к ресурсу.

## Когда появляется EnvoyFilter для HSTS?

### Текущая логика (после исправления)

EnvoyFilter создается **сразу при создании временного сертификата**, ДО того как он станет готовым и Gateway будет обновлен для его использования.

**Последовательность событий:**

1. **Обнаружение неготового сертификата** с `httpsRedirect: true`
   - Оператор обнаруживает, что Certificate не готов
   - Находит Gateway, использующий этот сертификат
   - Проверяет, что Gateway имеет `httpsRedirect: true`

2. **Создание временного сертификата** (`createSelfSignedCertificate`)
   - Создается временный Issuer (self-signed)
   - Создается временный Certificate
   - **Сразу после создания Certificate создается EnvoyFilter** ← **КЛЮЧЕВОЙ МОМЕНТ**

3. **Ожидание готовности временного сертификата**
   - cert-manager обрабатывает Certificate
   - Создается Secret с сертификатом

4. **Обновление Gateway** (`updateGatewayWithTemporarySecret`)
   - Gateway обновляется для использования временного секрета
   - `httpsRedirect` отключается на HTTP сервере (порт 80)
   - EnvoyFilter уже существует и активен

### Код создания EnvoyFilter

```go
// internal/controller/certificate_controller.go:572-577
logger.Info("Created temporary self-signed certificate for Gateway", ...)

// Создаем EnvoyFilter СРАЗУ при создании временного сертификата, ДО того как он станет готовым
// Это предотвращает кеширование HSTS заголовка браузером при первом обращении
if err := r.createEnvoyFilterToDisableHSTS(ctx, gateway, cert.Spec.SecretName); err != nil {
    logger.Error(err, "failed to create EnvoyFilter to disable HSTS (will retry later)", ...)
}
```

### Дополнительные места создания EnvoyFilter

EnvoyFilter также создается в следующих местах (для надежности):

1. **В `updateGatewayWithTemporarySecret`** - если EnvoyFilter был удален или не был создан
2. **В `ensureTemporaryCertificateSetup`** - при периодической проверке состояния
3. **Для готовых сертификатов** - если Gateway использует временный секрет (debug режим)

## Когда браузер кеширует заголовок HSTS?

### Процесс кеширования HSTS

1. **Первый HTTPS запрос к домену**
   - Браузер делает HTTPS запрос к домену
   - Сервер отвечает с заголовком `Strict-Transport-Security`

2. **Браузер сохраняет HSTS в локальном кеше**
   - Браузер читает заголовок `Strict-Transport-Security`
   - Извлекает значение `max-age` (время кеширования, обычно 31536000 секунд = 1 год)
   - Сохраняет домен в локальном HSTS кеше браузера

3. **Последующие запросы**
   - Браузер проверяет HSTS кеш перед каждым запросом
   - Если домен в кеше, браузер **принудительно** использует HTTPS
   - Даже если сервер больше не отправляет HSTS заголовок, браузер продолжает использовать HSTS из кеша

### Проблема с временными сертификатами

Если EnvoyFilter создается **ПОСЛЕ** первого обращения браузера:

1. Браузер делает HTTPS запрос
2. Сервер отвечает с HSTS заголовком (если он был настроен ранее)
3. Браузер кеширует HSTS
4. EnvoyFilter создается и начинает удалять HSTS заголовок
5. **Но браузер уже закешировал HSTS** и продолжает использовать его из кеша

**Результат:** Браузер блокирует доступ к сайту с самоподписанным сертификатом, даже если HSTS заголовок больше не отправляется.

## Можем ли убрать HSTS до первого обращения к ресурсу?

### Да! Это именно то, что делает оператор

**Решение:** Создавать EnvoyFilter **ДО** того, как временный сертификат станет готовым и Gateway начнет его использовать.

### Преимущества раннего создания EnvoyFilter

1. **EnvoyFilter активен с момента создания**
   - EnvoyFilter применяется к Envoy proxy сразу после создания
   - Lua фильтр начинает удалять HSTS заголовок немедленно

2. **Предотвращение кеширования HSTS**
   - Если браузер обращается к домену до готовности временного сертификата, HSTS заголовок уже удаляется
   - Браузер не кеширует HSTS, так как заголовок отсутствует в ответе

3. **Работает даже если Gateway еще не обновлен**
   - EnvoyFilter применяется на уровне Envoy proxy, независимо от Gateway конфигурации
   - Даже если Gateway еще использует оригинальный сертификат, EnvoyFilter уже активен

### Временная диаграмма

```
Время →
│
├─ [T0] Обнаружение неготового сертификата
│
├─ [T1] Создание временного Certificate
│   └─ [T1+1] Создание EnvoyFilter ← HSTS уже отключен!
│
├─ [T2] cert-manager обрабатывает Certificate
│   └─ EnvoyFilter активен, удаляет HSTS заголовок
│
├─ [T3] Временный сертификат готов
│   └─ Gateway обновляется для использования временного секрета
│   └─ EnvoyFilter уже активен
│
└─ [T4] Первое обращение браузера
    └─ HSTS заголовок отсутствует в ответе
    └─ Браузер НЕ кеширует HSTS ✓
```

### Важные моменты

1. **EnvoyFilter создается сразу при создании временного сертификата**
   - Не ждем готовности сертификата
   - Не ждем обновления Gateway

2. **EnvoyFilter активен независимо от Gateway конфигурации**
   - Применяется на уровне Envoy proxy
   - Работает даже если Gateway еще не обновлен

3. **Дополнительные проверки на случай ошибок**
   - EnvoyFilter также создается в `updateGatewayWithTemporarySecret` (на случай, если не был создан)
   - Периодическая проверка в `ensureTemporaryCertificateSetup`

## Проверка работы

### Проверка, что EnvoyFilter создан до готовности сертификата

```bash
# Создаем неготовый сертификат
kubectl apply -f certificate.yaml

# Проверяем, что временный сертификат создан
kubectl get certificate -n istio-system | grep temp

# Проверяем, что EnvoyFilter уже существует
kubectl get envoyfilter -n <gateway-namespace> | grep disable-hsts

# Проверяем готовность временного сертификата
kubectl get certificate <temp-cert-name> -n istio-system -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}'
# Должно быть "False" или "Unknown", но EnvoyFilter уже существует
```

### Проверка, что HSTS заголовок удаляется

```bash
# Делаем HTTPS запрос
curl -I -k https://example.com/echo

# Проверяем отсутствие HSTS заголовка
curl -I -k https://example.com/echo | grep -i "strict-transport-security"
# Должно быть пусто (заголовок удален)
```

## См. также

- [Временные сертификаты и управление HSTS](temporary-certificates.md) - подробное описание механизма
- [README.md](../README.md) - основная документация оператора
- [code-index.md](code-index.md) - индекс функций кода

